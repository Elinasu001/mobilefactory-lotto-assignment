<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.mobilefactory.lotto.event.model.dao.EventMapper">

    <resultMap id="eventResultMap" type="com.mobilefactory.lotto.event.model.vo.Event">
        <id property="eventId" column="EVENT_ID"/>
        <result property="eventName" column="EVENT_NAME"/>
        <result property="startDate" column="START_DATE"/>
        <result property="endDate" column="END_DATE"/>
        <result property="announceStart" column="ANNOUNCE_START"/>
        <result property="announceEnd" column="ANNOUNCE_END"/>
        <result property="maxParticipants" column="MAX_PARTICIPANTS"/>
        <result property="totalWinners" column="TOTAL_WINNERS"/>
        <result property="winningNumbers" column="WINNING_NUMBERS"/>
        <result property="forcedWinnerPhone" column="FORCED_WINNER_PHONE"/>
        <result property="status" column="STATUS"/>
        <result property="createdAt" column="CREATED_AT"/>
        <result property="updatedAt" column="UPDATED_AT"/>
    </resultMap>

    <!-- 현재 진행중인 이벤트 조회 -->
    <select id="selectActiveEvent" parameterType="Long" resultMap="eventResultMap">
        SELECT * FROM MF_EVENT
         WHERE
               STATUS = 'ACTIVE'
            AND
                EVENT_ID = #{eventId}
    </select>

    <!-- 이벤트 ID로 조회 -->
    <select id="selectById" parameterType="long" resultMap="eventResultMap">
        SELECT * FROM MF_EVENT
         WHERE 
               EVENT_ID = #{eventId}
    </select>

    <!-- 스케줄러 - 만료된 이벤트 마감 처리 -->
    <update id="closeExpiredEvents">
        UPDATE 
               MF_EVENT
           SET 
               STATUS = 'CLOSED',
               UPDATED_AT = SYSDATE
         WHERE 
               STATUS = 'ACTIVE'
           AND 
               END_DATE &lt; SYSDATE
    </update>

    <!-- 마감된 이벤트 조회 -->
    <select id="selectClosedEvent" parameterType="Long" resultMap="eventResultMap">
        SELECT * FROM MF_EVENT
         WHERE
               STATUS = 'CLOSED'
            AND
                EVENT_ID = #{eventId}
    </select>

</mapper>