<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.mobilefactory.lotto.auth.model.dao.AuthMapper">

    <!-- ResultMap -->
    <resultMap id="phoneAuthResultMap" type="PhoneAuth">
        <id property="authId" column="AUTH_ID"/>
        <result property="phoneNumber" column="PHONE_NUMBER"/>
        <result property="authCode" column="AUTH_CODE"/>
        <result property="isVerified" column="IS_VERIFIED"/>
        <result property="expiredAt" column="EXPIRED_AT"/>
        <result property="createdAt" column="CREATED_AT"/>
    </resultMap>

    <!-- 인증번호 저장 -->
    <insert id="insertPhoneAuth" parameterType="PhoneAuth">
        <selectKey keyProperty="authId" resultType="long" order="BEFORE">
            SELECT SEQ_PHONE_AUTH.NEXTVAL FROM DUAL
        </selectKey>
        INSERT
          INTO
               MF_PHONE_AUTH
               (
               AUTH_ID
             , PHONE_NUMBER
             , AUTH_CODE
             , IS_VERIFIED
             , EXPIRED_AT
               )
               VALUES
               (
               #{authId}
             , #{phoneNumber}
             , #{authCode}
             , 'N'
             , #{expiredAt}
               )
    </insert>

    <!-- 전화번호 + 인증번호로 조회 (검증용) -->
    <select id="selectVerifiedByPhoneAndCode"
            parameterType="PhoneAuthSearchVo"
            resultMap="phoneAuthResultMap">
        SELECT * FROM MF_PHONE_AUTH
         WHERE
               PHONE_NUMBER = #{phoneNumber}
           AND
               AUTH_CODE = #{authCode}
           AND
               EXPIRED_AT &gt; SYSDATE
           AND
               IS_VERIFIED = 'N'
         ORDER
            BY
               CREATED_AT DESC
        FETCH FIRST 1 ROW ONLY
    </select>

    <!-- 전화번호 + 인증번호로 조회 (참여/결과조회용)-->
    <select id="selectByPhoneAndCode"
            parameterType="PhoneAuthSearchVo"
            resultMap="phoneAuthResultMap">
        SELECT * FROM MF_PHONE_AUTH
         WHERE
               PHONE_NUMBER = #{phoneNumber}
           AND
               AUTH_CODE = #{authCode}
           AND
               EXPIRED_AT &gt; SYSDATE
           AND
               IS_VERIFIED = 'Y'
         ORDER
            BY
               CREATED_AT DESC
        FETCH FIRST 1 ROW ONLY
    </select>




    <!-- 인증 완료 처리 -->
    <update id="updateVerified" parameterType="long">
        UPDATE 
               MF_PHONE_AUTH
           SET 
               IS_VERIFIED = 'Y'
         WHERE 
               AUTH_ID = #{authId}
    </update>

</mapper>