package com.mobilefactory.lotto.event.model.service;

import java.util.Date;

import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import com.mobilefactory.lotto.common.exception.participant.ParticipantNotFoundException;
import com.mobilefactory.lotto.event.model.dao.ParticipantMapper;
import com.mobilefactory.lotto.event.model.dao.ResultCheckMapper;
import com.mobilefactory.lotto.event.model.dto.CheckResultRequest;
import com.mobilefactory.lotto.event.model.dto.CheckResultResponse;
import com.mobilefactory.lotto.event.model.vo.Event;
import com.mobilefactory.lotto.event.model.vo.Participant;
import com.mobilefactory.lotto.event.model.vo.ResultCheck;

import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;

@Slf4j
@Service
@RequiredArgsConstructor
public class ResultServiceImpl implements ResultService {

    private final EventService eventService;  // ← 추가
    private final ParticipantMapper participantMapper;
    private final ResultCheckMapper resultCheckMapper;

    @Override
    @Transactional
    public CheckResultResponse checkResult(CheckResultRequest request) {

        String phoneNumber = request.getPhoneNumber();
        Long eventId = request.getEventId();  // Request에 추가 필요

        log.info("결과 조회 시작 - 휴대폰: {}", phoneNumber);

        // 1. 발표된 이벤트 조회 (공통 서비스 활용!)
        Event event = eventService.getAnnouncedEvent(eventId);

        // 2. 발표 기간 확인
        Date now = new Date();
        if (now.before(event.getAnnounceStart()) || now.after(event.getAnnounceEnd())) {
            throw new IllegalStateException("발표 기간이 아닙니다.");
        }

        // 3. 참가자 조회
        Participant participant = participantMapper.selectByPhoneAndEvent(
            phoneNumber, 
            event.getEventId()
        );

        if (participant == null) {
            throw new ParticipantNotFoundException("참여 이력이 없습니다.");
        }

        // 4. 기존 확인 이력 조회
        ResultCheck existingCheck = resultCheckMapper.selectByParticipantId(
            participant.getParticipantId()
        );

        int checkCount = 0;
        if (existingCheck == null) {
            // 최초 확인
            checkCount = 1;
            resultCheckMapper.insertResultCheck(
                ResultCheck.builder()
                    .participantId(participant.getParticipantId())
                    .checkCount(checkCount)
                    .build()
            );
        } else {
            // 두 번째 확인
            checkCount = existingCheck.getCheckCount() + 1;
            if (checkCount <= 2) {
                resultCheckMapper.updateCheckCount(
                    participant.getParticipantId(), 
                    checkCount
                );
            }
        }

        // 5. 응답 생성
        return buildResponse(event, participant, checkCount);
    }

    private CheckResultResponse buildResponse(Event event, Participant participant, int checkCount) {

        boolean isWinner = "Y".equals(participant.getIsWinner());
        Integer prizeRank = participant.getPrizeRank();

        String message;
        if (checkCount == 1) {
            if (isWinner) {
                message = String.format("축하합니다! %d등에 당첨되셨습니다!", prizeRank);
            } else {
                message = "아쉽게도 당첨되지 않으셨습니다.";
            }
        } else {
            if (isWinner) {
                message = "당첨되셨습니다. (등수는 최초 확인 시에만 공개됩니다)";
                prizeRank = null;
            } else {
                message = "당첨되지 않으셨습니다.";
            }
        }

        return CheckResultResponse.builder()
            .eventId(event.getEventId())
            .eventName(event.getEventName())
            .phoneNumber(participant.getPhoneNumber())
            .lottoNumbers(participant.getLottoNumbers())
            .winningNumbers(event.getWinningNumbers())
            .isWinner(isWinner)
            .prizeRank(checkCount == 1 ? prizeRank : null)
            .checkCount(checkCount)
            .checkMessage(message)
            .build();
    }
}